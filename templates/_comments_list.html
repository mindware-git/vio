{% for comment in comments %}
    {% if not comment.parent %}  <!-- 원댓글만 표시 -->
        <div class="mb-4 p-4 border border-gray-200 rounded-lg">
            <div class="flex justify-between items-start">
                <div>
                    <span class="font-bold text-gray-800">{{ comment.name }}</span>
                    <span class="text-sm text-gray-500 ml-2">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                </div>
            </div>
            <p class="mt-2 text-gray-700">{{ comment.comment }}</p>
            <!-- Reply form for each comment -->
            <button onclick="toggleReplyForm({{ comment.id }})"
                    class="mt-2 text-sm text-blue-500 hover:text-blue-700">Reply</button>
            <div id="reply-form-{{ comment.id }}" class="mt-4 hidden">
                <form hx-post="{% url 'add_comment' person.slug %}"
                      hx-target="#comments-list"
                      hx-swap="innerHTML">
                    {% csrf_token %}
                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                    <div class="mb-2">
                        <label for="reply_user_name_{{ comment.id }}"
                               class="block text-gray-700 text-sm mb-1">Name</label>
                        <input type="text"
                               id="reply_user_name_{{ comment.id }}"
                               name="user_name"
                               required
                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="mb-2">
                        <label for="reply_comment_{{ comment.id }}"
                               class="block text-gray-700 text-sm mb-1">Reply</label>
                        <textarea id="reply_comment_{{ comment.id }}"
                                  name="comment"
                                  rows="2"
                                  required
                                  class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button type="submit"
                                class="bg-green-500 hover:bg-green-700 text-white text-sm py-1 px-3 rounded focus:outline-none focus:shadow-outline">
                            Post Reply
                        </button>
                        <button type="button"
                                onclick="toggleReplyForm({{ comment.id }})"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm py-1 px-3 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Replies -->
            {% for reply in comment.replies.all %}
                {% if not reply.is_removed %}
                    <div class="mt-3 p-3 border border-gray-100 rounded-lg ml-8 bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="font-bold text-gray-800 text-sm">{{ reply.name }}</span>
                                <span class="text-xs text-gray-500 ml-2">{{ reply.created_at|date:"Y-m-d H:i" }}</span>
                            </div>
                        </div>
                        <p class="mt-1 text-gray-700 text-sm">{{ reply.comment }}</p>
                        <!-- Reply form for each reply (대대댓글) -->
                        {% if reply.get_depth < 2 %}
                            <button onclick="toggleReplyForm({{ reply.id }})"
                                    class="mt-2 text-sm text-blue-500 hover:text-blue-700">Reply</button>
                            <div id="reply-form-{{ reply.id }}" class="mt-4 hidden">
                                <form hx-post="{% url 'add_comment' person.slug %}"
                                      hx-target="#comments-list"
                                      hx-swap="innerHTML">
                                    {% csrf_token %}
                                    <input type="hidden" name="parent_id" value="{{ reply.id }}">
                                    <div class="mb-2">
                                        <label for="reply_user_name_{{ reply.id }}"
                                               class="block text-gray-700 text-sm mb-1">Name</label>
                                        <input type="text"
                                               id="reply_user_name_{{ reply.id }}"
                                               name="user_name"
                                               required
                                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    </div>
                                    <div class="mb-2">
                                        <label for="reply_comment_{{ reply.id }}"
                                               class="block text-gray-700 text-sm mb-1">Reply</label>
                                        <textarea id="reply_comment_{{ reply.id }}"
                                                  name="comment"
                                                  rows="2"
                                                  required
                                                  class="w-full px-2 py-1 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button type="submit"
                                                class="bg-green-500 hover:bg-green-700 text-white text-sm py-1 px-3 rounded focus:outline-none focus:shadow-outline">
                                            Post Reply
                                        </button>
                                        <button type="button"
                                                onclick="toggleReplyForm({{ reply.id }})"
                                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 text-sm py-1 px-3 rounded focus:outline-none focus:shadow-outline">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
{% empty %}
    <p class="text-gray-500">No comments yet. Be the first to comment!</p>
{% endfor %}
