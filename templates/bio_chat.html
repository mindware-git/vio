{% extends "base.html" %}
{% block title %}{{ person.name }} - AI Chat{% endblock %}
{% block content %}
    <div class="container mx-auto p-4">
        <!-- Header with Back Button -->
        <div class="flex items-center mb-6">
            <a href="{% url 'bio_detail' person.slug %}"
               class="flex items-center text-blue-500 hover:text-blue-700 font-medium">
                <svg class="w-5 h-5 mr-2"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                뒤로가기
            </a>
            <h1 class="text-2xl font-bold ml-4">{{ person.name }}와의 대화</h1>
        </div>
        <!-- Chat Container -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div id="chat-messages" class="mb-4 h-96 overflow-y-auto">
                <!-- Messages will be displayed here -->
            </div>
            <!-- Chat Input Form -->
            <form id="chat-form" class="flex">
                {% csrf_token %}
                <input type="text"
                       id="user-input"
                       name="message"
                       placeholder="메시지를 입력하세요..."
                       class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       required>
                <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-r-lg focus:outline-none focus:shadow-outline">
                    전송
                </button>
            </form>
        </div>
    </div>
    <!-- JavaScript for handling chat functionality -->
    <script>
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (message) {
                // Add user message to chat
                addMessageToChat(message, 'user');
                
                // Clear input
                userInput.value = '';
                
                // Send message to server (echo for now)
                fetch(window.location.href, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        'message': message
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Add AI response to chat
                    addMessageToChat(data.response, 'ai');
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessageToChat('오류가 발생했습니다.', 'ai');
                });
            }
        });
        
        function addMessageToChat(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            
            messageElement.classList.add('mb-3');
            
            if (sender === 'user') {
                messageElement.classList.add('text-right');
                messageElement.innerHTML = `
                    <div class="inline-block bg-blue-500 text-white rounded-lg px-4 py-2 max-w-xs md:max-w-md">
                        ${message}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">나</div>
                `;
            } else {
                messageElement.classList.add('text-left');
                messageElement.innerHTML = `
                    <div class="inline-block bg-gray-200 text-gray-800 rounded-lg px-4 py-2 max-w-xs md:max-w-md">
                        ${message}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">AI</div>
                `;
            }
            
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    </script>
{% endblock %}
